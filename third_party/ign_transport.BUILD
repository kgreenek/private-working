# Description:
#   The transport library combines ZeroMQ with Protobufs to create a fast and efficient message
#   passing system. Asynchronous message publication and subscription is provided along with service
#   calls and discovery.

licenses(["notice"])  # Apache 2.0

exports_files(["LICENSE"])

cc_library(
    name = "ign_transport",
    srcs = glob(
        ["src/*.cc"],
        exclude = ["src/*_TEST.cc"]
    ),
    hdrs = [
        ":config_hh",
        ":hdrs",
        ":transport_hh",
    ],
    includes = ["include"],
    linkopts = ["-luuid"],
    deps = [
        "//external:cppzmq",
        "//external:ign_math",
        "//external:ign_msgs",
        "//external:zmq",
    ],
    visibility = ["//visibility:public"],
)

filegroup(
    name = "hdrs",
    srcs = glob(["include/ignition/transport/*.hh"]),
    visibility = ["//visibility:private"],
)

genrule(
    name = "config_hh",
    outs = ["ignition/transport/config.hh"],
    cmd = """
        echo '/* Config.hh. Generated by CMake for ignition-transport. */' >> $@
        echo '' >> $@
        echo '/* Version number */' >> $@
        echo '#define IGNITION_TRANSPORT_MAJOR_VERSION 3' >> $@
        echo '#define IGNITION_TRANSPORT_MINOR_VERSION 0' >> $@
        echo '#define IGNITION_TRANSPORT_PATCH_VERSION 1' >> $@
        echo '' >> $@
        echo '#define IGNITION_TRANSPORT_VERSION "3.0"' >> $@
        echo '#define IGNITION_TRANSPORT_VERSION_FULL "3.0.1"' >> $@
        echo '' >> $@
        echo '#define IGNITION_TRANSPORT_VERSION_HEADER "Ignition transport, version 3.0.1\\nCopyright (C) 2014 Open Source Robotics Foundation.\\nReleased under the Apache 2.0 License.\\n\\n"' >> $@
        echo '' >> $@
        echo '/* #undef BUILD_TYPE_PROFILE */' >> $@
        echo '/* #undef BUILD_TYPE_DEBUG */' >> $@
        echo '#define BUILD_TYPE_RELEASE 1' >> $@
        echo '' >> $@
        echo '#define HAVE_IFADDRS 1' >> $@
    """,
    visibility = ["//visibility:private"],
)

genrule(
    name = "transport_hh",
    srcs = [
        ":config_hh",
        ":hdrs",
    ],
    outs = ["ignition/transport.hh"],
    cmd = """
        echo '// Automatically generated' >> $@
        for src in $(SRCS); do
          echo '#include \"ignition/transport/'"$$(basename $$src)"'\"' >> $@
        done
    """,
    visibility = ["//visibility:private"],
)
